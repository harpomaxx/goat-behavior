---
title: "SHAP Values for goat behavior"
output: html_notebook
---
# Goat behavior
## FASTSHAP

```{r}
# Load required packages
library(dplyr)
library(doMC)
library(fastshap)  # for fast (approximate) Shapley values
#library(ranger)    # for fast random forest algorithm

# Simulate training data
#trn <- gen_friedman(3000, seed = 101)
#X <- subset(trn, select = -y)  # feature columns only
p_function_G<- function(object, newdata) caret::predict.train(object, newdata = newdata, type = "prob")[,"G"]
p_function_GM<- function(object, newdata) caret::predict.train(object, newdata = newdata, type = "prob")[,"GM"]
#p_function_RS<- function(object, newdata) caret::predict.train(object, newdata = newdata, type = "prob")[,"RS"]
#p_function_RL<- function(object, newdata) caret::predict.train(object, newdata = newdata, type = "prob")[,"RL"]
p_function_R<- function(object, newdata) caret::predict.train(object, newdata = newdata, type = "prob")[,"R"]
p_function_W<- function(object, newdata) caret::predict.train(object, newdata = newdata, type = "prob")[,"W"]

trainset<-train_dataset %>% 
            select(selected_variables$variable) %>% #select(-prevActivity1,-prevActivity2,-prevActivity3) %>%
            na.omit() %>% 
            as.data.frame()
trainset_y<-train_dataset %>% 
            select(Activity) %>%
            na.omit() %>% unlist() %>% unname()


trainset_G<-trainset[which(trainset_y=="G"),]
trainset_GM<-trainset[which(trainset_y=="GM"),]
#trainset_RS<-trainset[which(trainset_y=="RS"),]
#trainset_RL<-trainset[which(trainset_y=="RL"),]
trainset_R<-trainset[which(trainset_y=="R"),]
trainset_W<-trainset[which(trainset_y=="W"),]

                    
#ranks<-rank(-table(trainset_y), ties.method="first")
#trainset_y<-ranks[trainset_y] %>% unname()
#readr::write_csv(cbind(trainset,Activity=trainset_y),"goat-dataset-example.csv")
#caret::predict.train(boostFit, newdata = trainset, type='prob')[,"RL"]
# Compute fast (approximate) Shapley values using 10 Monte Carlo repetitions
shap_values_G <- fastshap::explain(boostFit, X = trainset, pred_wrapper = p_function_G, nsim = 50,newdata=trainset_G)
shap_values_GM <- fastshap::explain(boostFit, X = trainset, pred_wrapper = p_function_GM, nsim = 50,newdata=trainset_GM)
#shap_values_RS<- fastshap::explain(boostFit, X = trainset_RS, pred_wrapper = p_function_RS, nsim = 10)
#shap_values_RL <- fastshap::explain(boostFit, X = trainset_RL, pred_wrapper = p_function_RL, nsim = 10)
shap_values_R<- fastshap::explain(boostFit, X = trainset, pred_wrapper = p_function_R, nsim = 50,newdata=trainset_R)
shap_values_W <- fastshap::explain(boostFit, X = trainset, pred_wrapper = p_function_W, nsim = 50,newdata=trainset_W,adjust=TRUE)

shap_values_W[8,] %>% sum()+0.145
p_function_W(boostFit,trainset_W[8,])

p1<-autoplot(shap_values_G[13,], type = "contribution")+ggdark::dark_theme_classic()

p2 <- autoplot(shap_values_G, type = "dependence", feature = "Active", X = trainset_G, alpha = 0.5,
               color_by = "Active", smooth = TRUE, smooth_color = "orange") +
        scale_color_viridis_c()
gridExtra::grid.arrange(p1, p2+ggdark::dark_theme_classic(), nrow = 1)

#ggsave("/tmp/shap-value-one-instance.png",height = 3, width = 4,units = 'in')

#trainset_melted %>% group_by(class) %>% summarise(n=n()) %>% summarise(class=class,percent=n/sum(n))
#ggsave(p1p2,"/tmp/contribution-dependecy.png",height = 3, width = 4,units = 'in')
#ggsave("/tmp/shap-basic.png",height = 3, width = 4,units = 'in')

```
### Force plots
```{r}
force_plot(object = shap_values_W[8L,], feature_values = trainset_W[8L, ], display = "html",baseline = 0.14) 
```

```{r}
trainset_GM$class<-"GM"
trainset_G$class<-"G"
#trainset_RL$class<-"RL"
#trainset_RS$class<-"RS"
trainset_R$class<-"R"
trainset_W$class<-"W"

trainset_G  <- trainset_G %>% reshape2::melt() 
trainset_GM <- trainset_GM %>% reshape2::melt() 
#trainset_RL <- trainset_RL %>% reshape2::melt() 
#trainset_RS <- trainset_RS %>% reshape2::melt() 
trainset_R <- trainset_R %>% reshape2::melt() 
trainset_W <- trainset_W %>% reshape2::melt() 

trainset_melted<-rbind(trainset_G,
                   trainset_GM
                  # trainset_RL
                  #,trainset_RS
                  ,trainset_R
                  ,trainset_W
                   
                   )

range01 <- function(x){(x-min(x))/(max(x)-min(x))}
trainset_melted_scaled<-trainset_melted %>% group_by(variable) %>% mutate(value_scale=range01(value))
```


```{r}
shap_values_GM$class<-"GM"
shap_values_G$class<-"G"
#shap_values_RL$class<-"RL"
#shap_values_RS$class<-"RS"
shap_values_R$class<-"R"
shap_values_W$class<-"W"

shap_value_G  <- shap_values_G %>% reshape2::melt() 
shap_value_GM <- shap_values_GM %>% reshape2::melt() 
#shap_value_RL <- shap_values_RL %>% reshape2::melt() 
#shap_value_RS <- shap_values_RS %>% reshape2::melt() 
shap_value_R <- shap_values_R %>% reshape2::melt() 
shap_value_W <- shap_values_W %>% reshape2::melt() 

shap_values<-rbind(shap_value_G,
                   shap_value_GM,
                  # shap_value_RL
                  #,shap_value_RS
                   shap_value_R,
                   shap_value_W
                   
                   )

shap_values
```
### Summary plots
```{r}
shap_values %>% group_by(class,variable) %>% summarise(mean=mean(abs(value))) %>% arrange(desc(mean)) %>%
  ggplot()+
  ggdark::dark_theme_classic()+
  geom_col(aes(y=variable,x=mean,group = class, fill = class),position="stack")+
  xlab("Mean(|Shap Value|) Average impact on model output magnitude")
pl<-plotly::ggplotly()
pl
#pl<-plotly::partial_bundle(pl)
#htmlwidgets::saveWidget(pl,"/tmp/plotly.html")
```

```{r fig.height=8, fig.width=12}


cbind(shap_values, feature_value=trainset_melted_scaled$value_scale) %>% # filter(class=="GM") %>%
  ggplot()+
  facet_wrap(~class)+
  ggdark::dark_theme_bw()+
 # geom_jitter(aes(y=variable,x=value, color = value), position = position_jitter(w = 0, h = 0.4),size=0.1)
  #geom_violin(aes(y=variable,x=value))+
  geom_hline(yintercept=0, 
                color = "red", size=0.5)+
  ggforce::geom_sina(aes(x=variable,y=value,color=feature_value),size=0.8,bins=4,alpha=0.5)+
    scale_colour_gradient(low = "yellow", high = "red", na.value = NA)+
   #scale_colour_gradientn(colours = terrain.colors(10))+
  xlab("Feature")+ylab("SHAP value")+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
  
  #xlab("Mean(|Shap Value|) Average impact on model output magnitude")


#plotly::ggplotly()
#autoplot(shap_values, type = "contribution", row_num = 2)
#plotly::ggplotly()
```

### Dependency plots

```{r}
#features_values<-cbind(trainset,class=trainset_y) %>% reshape2::melt(id.vars="class")
#features_values %>% filter(variable=="Standing" & value >1)

p2<-cbind(shap_values, feature_value=trainset_melted_scaled$value_scale)  %>% filter(variable=="Active",class=="R" ) %>%

ggplot(aes(x=feature_value, y=value)) +
  ggdark::dark_theme_bw()+
  geom_point(alpha = 0.3,color='orange') +
  geom_smooth(color='red') +
  ylab("Shapley value")
p2
```
